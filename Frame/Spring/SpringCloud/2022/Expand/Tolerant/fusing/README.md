# 熔断

在分布式与微服务系统中，如果下游服务因为访问压力过大导致响应很慢或者一直调用失败时，上游服务为了保证系统的整体可用性，不再继续调用目标服务，直接返回，快速释放资源，暂时断开与下游服务的调用连接。这种方式就是熔断。类比保险丝达到最大服务访问后，直接拒绝访问，拉闸限电，然后调用服务降级的方法并返回友好提示。如果目标服务情况好转则恢复调用。

**熔断器模型**：

![image.png](https://cdn.jsdelivr.net/gh/letengzz/Two-C@main/img/Java/202303301456720.png)

熔断器模型的状态机有3个状态：闭合、开启和半熔断

- **闭合状态**(断路器关闭，Closed)：所有请求都正常访问，没有故障时，上游服务调用下游服务时，不会有任何限制。

- **打开状态**(断路器打开，Open)：所有请求都会被降级。熔断器会对请求情况计数，当一定时间内失败请求百分比达到阈值，则触发熔断，断路器会完全打开。上游服务不再调用下游服务的接口，会直接返回上游服务中预定的方法。

- **半开状态**(Half Open)：不是永久的，断路器打开后会进入休眠时间。随后断路器会自动进入半开状态。此时会释放部分请求通过，若这些请求都是健康的，则会关闭断路器，否则继续保持打开，再次进行休眠计时。 上游服务会根据一定的规则，尝试恢复对下游服务的调用。此时，上游服务会以有限的流量来调用下游服务，同时，会监控调用的成功率。如果成功率达到预期，则进入关闭状态。如果未达到预期，会重新进入开启状态。